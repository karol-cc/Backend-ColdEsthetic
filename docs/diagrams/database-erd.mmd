---
title: Database ERD
config:
    layout: elk
---
erDiagram
    direction LR
        USERS ||--o{ PATIENTS : creates
        USERS ||--o{ PROCEDURES : creates
        USERS ||--o{ MEDICAL_EVALUATIONS : writes
        USERS ||--o{ CLINICAL_IMAGES : uploads

        PATIENTS ||--o{ PROCEDURES : has
        PATIENTS ||--o{ MEDICAL_EVALUATIONS : has
        PROCEDURES ||--o{ PROCEDURE_ITEMS : includes
        PROCEDURES ||--o| MEDICAL_EVALUATIONS : has

    CACHE[Cache] {
        int expiration
        string key
    }

    CACHE_LOCKS[CacheLock] {
        int expiration
        string key
        string owner
    }

    CLINICAL_IMAGES[ClinicalImage] {
        bigint id PK
        string after_image
        string before_image
        datetime created_at
        text description
        string title
        datetime updated_at
        bigint user_id FK
    }

    FAILED_JOBS[FailedJob] {
        bigint id PK
        text connection
        text exception
        datetime failed_at
        text payload
        text queue
        string uuid
    }

    JOB_BATCHES[JobBatch] {
        string id
        int cancelled_at
        int created_at
        text failed_job_ids
        int failed_jobs
        int finished_at
        string name
        int pending_jobs
        int total_jobs
    }

    JOBS[Job] {
        bigint id PK
        text payload
        string queue
    }

    MEDICAL_EVALUATIONS[MedicalEvaluation] {
        bigint id PK
        bigint procedure_id FK
        datetime created_at
        text evaluation_data "JSON serializado (LONGTEXT en MySQL)"
        text notes
        bigint patient_id FK
        datetime updated_at
        bigint user_id FK
    }

    PASSWORD_RESET_TOKENS[PasswordResetToken] {
        datetime created_at
        string email
        string token
    }

    PATIENTS[Patient] {
        bigint id PK
        int age
        float bmi
        string cellphone
        datetime created_at
        string first_name
        float height
        string last_name
        string referrer_name "Remitente (texto libre)"
        text medical_background
        string biological_sex
        datetime updated_at
        bigint user_id FK
        float weight
    }

    PERSONAL_ACCESS_TOKENS[PersonalAccessToken] {
        bigint id PK
        text abilities
        datetime created_at
        datetime expires_at
        datetime last_used_at
        text name
        string token
        datetime updated_at
    }

    PROCEDURE_ITEMS[ProcedureItem] {
        bigint id PK
        datetime created_at
        string item_name
        decimal price
        json meta
        bigint procedure_id FK
        datetime updated_at
    }

    PROCEDURES[Procedure] {
        bigint id PK
        datetime created_at
        bigint patient_id FK
        string brand_slug
        date procedure_date
        text notes
        decimal total_amount
        datetime updated_at
        bigint user_id FK
    }

    SESSIONS[Session] {
        string id
        string ip_address
        int last_activity
        text payload
        text user_agent
    }

    USERS[User] {
        bigint id PK
        string brand_name
        string brand_slug
        string cellphone
        datetime created_at
        string email
        datetime email_verified_at
        string first_name
        string last_name
        string name
        string password
        datetime updated_at
    }

    %% Visual: separa tablas de negocio vs infraestructura Laravel
    classDef domain fill:#E6FFFA,stroke:#2C7A7B,stroke-width:2px
    classDef infra fill:#F7FAFC,stroke:#718096,stroke-dasharray: 3 3
    class USERS,PATIENTS,PROCEDURES,PROCEDURE_ITEMS,MEDICAL_EVALUATIONS,CLINICAL_IMAGES domain
    class CACHE,CACHE_LOCKS,FAILED_JOBS,JOB_BATCHES,JOBS,PASSWORD_RESET_TOKENS,PERSONAL_ACCESS_TOKENS,SESSIONS infra
